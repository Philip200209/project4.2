{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>CRB History</h3>
    <div>
      <a href="{{ url_for('crb_dashboard') }}" class="btn btn-sm btn-outline-secondary">Back to CRB Dashboard</a>
    </div>
  </div>

  <form method="GET" action="{{ url_for('crb_history_lookup') }}" class="row g-2 mb-4">
    <div class="col-sm-5 col-md-4">
      <input type="text" name="national_id" value="{{ national_id or '' }}" class="form-control" placeholder="Enter National ID" required>
    </div>
    <div class="col-sm-3 col-md-3">
      <select name="sort" class="form-select">
        <option value="date_desc" {% if sort == 'date_desc' %}selected{% endif %}>Newest first</option>
        <option value="date_asc" {% if sort == 'date_asc' %}selected{% endif %}>Oldest first</option>
        <option value="score_desc" {% if sort == 'score_desc' %}selected{% endif %}>Score high → low</option>
        <option value="score_asc" {% if sort == 'score_asc' %}selected{% endif %}>Score low → high</option>
      </select>
    </div>
    <div class="col-sm-2 col-md-2">
      <select name="per_page" class="form-select">
        {% for n in [10,20,50] %}
          <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }}/page</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-sm-2 col-md-2 form-check d-flex align-items-center">
      <input class="form-check-input me-2" type="checkbox" value="1" name="blacklisted" id="blacklistedOnly" {% if blacklisted %}checked{% endif %}>
      <label class="form-check-label" for="blacklistedOnly">Blacklisted only</label>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">Search</button>
    </div>
    {% if national_id %}
    <div class="col-auto">
      <a class="btn btn-outline-success" href="{{ url_for('crb_history_export_csv', national_id=national_id, sort=sort, blacklisted=1 if blacklisted else 0) }}">Export CSV</a>
    </div>
    {% endif %}
  </form>

  {% if national_id and not reports %}
    <div class="alert alert-info">No CRB reports found for National ID: <strong>{{ national_id }}</strong></div>
  {% endif %}

  {% if reports and reports|length > 0 %}
  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>Date</th>
          <th>National ID</th>
          <th>Phone</th>
          <th>Loan ID</th>
          <th>Credit Score</th>
          <th>Defaults</th>
          <th>Utilization</th>
          <th>Arrears (days)</th>
          <th>Blacklisted</th>
          <th>Bureau</th>
        </tr>
      </thead>
      <tbody>
        {% for r in reports %}
        <tr class="{% if r.blacklist_status %}table-danger{% endif %}">
          <td>{{ (r.created_at or r.report_date).strftime('%Y-%m-%d %H:%M') if r.created_at or r.report_date else '—' }}</td>
          <td>{{ r.national_id }}</td>
          <td>{{ r.phone_number }}</td>
          <td>
            {% if r.loan_id %}
              <a href="{{ url_for('loan_repayments', loan_id=r.loan_id) }}">{{ r.loan_id }}</a>
            {% else %}
              —
            {% endif %}
          </td>
          <td>{{ r.credit_score or 0 }}</td>
          <td>{{ r.default_history or 0 }}</td>
          <td>{{ (r.credit_utilization or 0)|round(2) }}</td>
          <td>{{ r.days_arrears or 0 }}</td>
          <td>
            {% if r.blacklist_status %}
              <span class="badge bg-danger">Yes</span>
            {% else %}
              <span class="badge bg-success">No</span>
            {% endif %}
          </td>
          <td>{{ r.crb_bureau or '—' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  {% if pagination %}
  <nav aria-label="CRB pagination" class="mt-3">
    <ul class="pagination">
      <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('crb_history_lookup', national_id=national_id, sort=sort, per_page=per_page, blacklisted=1 if blacklisted else 0, page=pagination.prev_num) }}">Previous</a>
      </li>
      <li class="page-item disabled"><span class="page-link">Page {{ pagination.page }} of {{ pagination.pages }}</span></li>
      <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('crb_history_lookup', national_id=national_id, sort=sort, per_page=per_page, blacklisted=1 if blacklisted else 0, page=pagination.next_num) }}">Next</a>
      </li>
    </ul>
  </nav>
  {% endif %}
</div>
{% endblock %}
