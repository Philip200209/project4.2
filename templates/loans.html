{% extends 'base.html' %}
{% block title %}Loans Management Â· CRIMAP{% endblock %}
{% block extra_head %}
<style>
    .loans-table,
    .loans-table th,
    .loans-table td {
        background: #fefefe;
        color: #1f1b2e;
    }

    .loans-table tbody tr:nth-child(2n) {
        background: #f0f3f8;
    }

    .loans-table tbody tr:hover {
        background: rgba(76, 130, 255, 0.12);
    }

    .loans-table .text-muted {
        color: #5f6a86 !important;
    }
</style>
{% endblock %}
{% block content %}
<div class="page-card">
    <div class="header" style="border: none; padding: 0; margin-bottom: 24px;">
        <div>
            <h2><i class="fas fa-clipboard-list"></i> Loans Management</h2>
            <p class="text-muted">Manage and review all loan applications in one workspace.</p>
        </div>
        {% if current_user.role == 'borrower' %}
        <a href="{{ url_for('apply_loan') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Apply for Loan
        </a>
        {% endif %}
    </div>

    <div class="stats-grid" style="margin-bottom: 26px;">
        <div class="stat-card">
            <h3><i class="fas fa-file-invoice-dollar"></i> Total Loans</h3>
            <div class="count">{{ total_loans }}</div>
            <span class="trend">Across all statuses</span>
        </div>
        <div class="stat-card approved">
            <h3><i class="fas fa-check-circle"></i> Approved</h3>
            <div class="count">{{ approved_loans }}</div>
            <span class="trend">Ready for disbursement</span>
        </div>
        <div class="stat-card pending">
            <h3><i class="fas fa-clock"></i> Pending</h3>
            <div class="count">{{ pending_loans }}</div>
            <span class="trend">Awaiting decision</span>
        </div>
        <div class="stat-card rejected">
            <h3><i class="fas fa-times-circle"></i> Rejected</h3>
            <div class="count">{{ rejected_loans }}</div>
            <span class="trend">Requires follow-up</span>
        </div>
    </div>

    {% if loans %}
    <div class="table-wrapper">
        <table class="table table-hover loans-table">
            <thead>
                <tr>
                    <th>Applicant</th>
                    <th>Amount</th>
                    <th>Term</th>
                    <th>Purpose</th>
                    <th>Status</th>
                    <th>Risk Score</th>
                    <th>Applied Date</th>
                    {% if current_user.role in ['admin', 'loan_officer'] %}
                    <th>Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for loan in loans %}
                <tr>
                    <td>
                        <strong>{{ loan.client_name }}</strong><br>
                        <span class="text-muted">{{ loan.client_email }}</span>
                    </td>
                    <td>KSh {{ '%.2f'|format(loan.amount) }}</td>
                    <td>{{ loan.term }} months</td>
                    <td>{{ loan.purpose }}</td>
                    <td>
                        <span class="badge {% if loan.status == 'approved' %}bg-green-600{% elif loan.status == 'pending' %}bg-yellow-500{% else %}bg-red-600{% endif %}">
                            {{ loan.status|title }}
                        </span>
                    </td>
                    <td>
                        <div style="display:flex; align-items:center; gap:12px;">
                            <span>{{ '%.1f'|format(loan.risk_score) }}%</span>
                            <div style="flex:1; min-width:100px; height:6px; background:rgba(255,255,255,0.12); border-radius:999px;">
                                <div style="height:100%; border-radius:999px; width: {{ loan.risk_score }}%; background:{% if loan.risk_score < 40 %}linear-gradient(135deg,#2ec4b6,#1cae9c){% elif loan.risk_score < 70 %}linear-gradient(135deg,#ffd166,#fca311){% else %}linear-gradient(135deg,#ef476f,#d42552){% endif %};"></div>
                            </div>
                        </div>
                    </td>
                    <td>{{ loan.created_at.strftime('%Y-%m-%d') }}</td>
                    {% if current_user.role in ['admin', 'loan_officer'] %}
                    <td style="display:flex; gap:8px;">
                        <form action="{{ url_for('update_loan_status', loan_id=loan.id) }}" method="POST" style="display:flex; gap:8px;">
                            {% if loan.status != 'approved' %}
                            <button type="submit" name="status" value="approved" class="btn btn-primary" style="padding:8px 12px;">
                                <i class="fas fa-check"></i>
                            </button>
                            {% endif %}
                            {% if loan.status != 'rejected' %}
                            <button type="submit" name="status" value="rejected" class="btn btn-danger" style="padding:8px 12px;">
                                <i class="fas fa-xmark"></i>
                            </button>
                            {% endif %}
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info" style="display:flex; align-items:center; gap:12px;">
        <i class="fas fa-info-circle"></i>
        <span>
            {% if current_user.role == 'borrower' %}
                You have not submitted any loan applications yet.
            {% else %}
                There are currently no loan applications in the system.
            {% endif %}
        </span>
    </div>
    {% if current_user.role == 'borrower' %}
    <div style="margin-top:16px;">
        <a href="{{ url_for('apply_loan') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Apply for Your First Loan
        </a>
    </div>
    {% endif %}
    {% endif %}
</div>
{% endblock %}